<form id="job-form" 
      hx-post="/api/jobs" 
      hx-target="#job-form-error"
      hx-swap="innerHTML" 
      class="space-y-4">
    
    <div id="job-form-error">
        {% if let Some(error) = error %}
        <div class="p-3 mb-4 text-sm text-red-200 bg-red-500/20 rounded-lg border border-red-500/30">
            {{ error }}
        </div>
        {% endif %}
    </div>

    <div>
        <label class="block text-sm font-medium text-slate-400 mb-1">Job Name</label>
        <input type="text" name="name" required value="{{ form.name }}"
               class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-200 focus:ring-2 focus:ring-primary-500"
               placeholder="my_job">
    </div>
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium text-slate-400 mb-1">Data Source</label>
            <select name="datasource" id="datasource-select" required
                    onchange="updateMethodOptions()"
                    class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-200">
                {% for ds in available_datasources %}
                <option value="{{ ds }}" {% if form.datasource == ds.as_str() %}selected{% endif %}>{{ ds }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-slate-400 mb-1">Method</label>
            <select name="method" id="method-select" required
                    onchange="updateCreateParamsInputs()"
                    class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-200">
                <!-- Options will be populated by JavaScript -->
            </select>
        </div>
    </div>
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium text-slate-400 mb-1">Schedule Type</label>
            <select name="schedule_type" id="schedule_type"
                    onchange="toggleScheduleInput()"
                    class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-200">
                <option value="interval" {% if form.schedule_type == "interval" %}selected{% endif %}>Interval (seconds)</option>
                <option value="cron" {% if form.schedule_type == "cron" %}selected{% endif %}>Cron Expression</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-slate-400 mb-1">Schedule Value</label>
            <input type="text" name="schedule_value" required id="schedule_value" value="{{ form.schedule_value }}"
                   class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-200"
                   placeholder="60">
        </div>
    </div>
    <div id="create-params-container">
        <!-- Dynamic params inputs will be inserted here -->
    </div>
    <input type="hidden" name="params" id="create-params-json">
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium text-slate-400 mb-1">Retention Days</label>
            <input type="number" name="retention_days" min="1" max="365" value="{{ form.retention_days }}"
                   class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-200">
        </div>
        <div class="flex items-end pb-2">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" name="enabled" value="true" class="accent-primary-500 w-4 h-4" 
                       {% if form.enabled.is_some() %}checked{% endif %}>
                <span class="text-sm text-slate-300">Enabled</span>
            </label>
        </div>
    </div>
    <div class="flex justify-end gap-3 pt-4 border-t border-slate-800">
        <button type="button" onclick="document.getElementById('create-modal').classList.add('hidden')"
                class="px-4 py-2 text-sm text-slate-400 hover:text-slate-200">
            Cancel
        </button>
        <button type="submit"
                class="px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-lg text-sm font-medium">
            Create Job
        </button>
    </div>
</form>

<script>
    // Methods mapping from server (with params metadata)
    const createMethodsMap = {{ methods_json|safe }};
    const currentMethod = "{{ form.method }}";
    
    function updateMethodOptions() {
        const datasource = document.getElementById('datasource-select').value;
        const methodSelect = document.getElementById('method-select');
        const methods = createMethodsMap[datasource] || {};
        
        // Clear existing options
        methodSelect.innerHTML = '';
        
        // Add new options (methods is now an object with method names as keys)
        Object.keys(methods).forEach(function(method) {
            const option = document.createElement('option');
            option.value = method;
            option.textContent = method;
            if (method === currentMethod) {
                option.selected = true;
            }
            methodSelect.appendChild(option);
        });
        
        updateCreateParamsInputs();
    }
    
    function updateCreateParamsInputs() {
        const datasource = document.getElementById('datasource-select').value;
        const method = document.getElementById('method-select').value;
        const container = document.getElementById('create-params-container');
        
        const methodMeta = createMethodsMap[datasource]?.[method];
        const params = methodMeta?.params || [];
        
        if (params.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        let html = '<div class="space-y-3"><label class="block text-sm font-medium text-slate-400 mb-1">Parameters</label>';
        params.forEach(function(param) {
            const requiredBadge = param.required ? '<span class="text-red-400 ml-1">*</span>' : '';
            html += `
                <div>
                    <label class="block text-xs text-slate-500 mb-1">${param.name}${requiredBadge}</label>
                    <input type="text" name="create_param_${param.name}" id="create-param-${param.name}"
                           ${param.required ? 'required' : ''}
                           class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-200"
                           placeholder="${param.description}">
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }
    
    // Before form submit, collect params into JSON
    document.getElementById('job-form').addEventListener('submit', function(e) {
        const params = {};
        const formData = new FormData(this);
        for (const [key, value] of formData.entries()) {
            if (key.startsWith('create_param_') && value) {
                params[key.replace('create_param_', '')] = value;
            }
        }
        if (Object.keys(params).length > 0) {
            document.getElementById('create-params-json').value = JSON.stringify(params);
        }
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', updateMethodOptions);
    // Also run immediately in case DOM is already loaded
    if (document.readyState !== 'loading') {
        updateMethodOptions();
    }
</script>

